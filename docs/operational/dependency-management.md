# Dependency Management Guide

> **guide** for managing dependencies with uv package manager

**Quick Reference:** [Quick Start Cheatsheet](../reference/quick-start-cheatsheet.md) | [Common Workflows](../reference/common-workflows.md) | [Troubleshooting Guide](../operational/troubleshooting-guide.md)

This guide provides instructions for managing Python dependencies using the `uv` package manager, which is the recommended tool for this template.

## Overview

The template uses `uv` for fast and reliable dependency management. The `uv` tool provides:

- Fast dependency resolution
- Lock file management
- Python version management
- Virtual environment handling
- Integration with existing Python workflows

## Installation

### Installing uv

**macOS/Linux:**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
```

**Windows:**
```powershell
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**Verify installation:**
```bash
uv --version
```

## Project Configuration

### pyproject.toml

Dependencies are defined in `pyproject.toml`:

```toml
[project]
name = "research-project-template"
version = "2.0.0"
requires-python = ">=3.10"
dependencies = [
    "numpy>=1.22",
    "matplotlib>=3.7",
    "pypdf>=5.0",
    "pyyaml>=6.0",
]

[project.scripts]
# Development workflow scripts (run with: uv run <script-name>)
test = "pytest tests/ --cov=infrastructure --cov=projects/project/src --cov-report=html"
test-infra = "pytest tests/infra_tests/ --cov=infrastructure --cov-report=html"
test-project = "pytest projects/project/tests/ --cov=projects/project/src --cov-report=html"

[dependency-groups]
# Development dependencies
dev = [
    "pytest>=7.0",
    "pytest-cov>=4.0",
    "mypy>=1.17.1",
]

[tool.uv]
# uv-specific configuration
managed = true  # Use uv's virtual environment management
package = false  # This is not a distributable package

[tool.uv.workspace]
# Workspace configuration for multi-project support
members = [
    "projects/code_project"
]
```

### Using uv with Scripts

The template provides convenient scripts via `[project.scripts]` that can be run with `uv run`:

```bash
# Run test suite
uv run test

# Run infrastructure tests only
uv run test-infra

# Run project tests only
uv run test-project

# Run type checking
uv run type-check

# Run security checks
uv run security
```

Alternatively, execute Python scripts directly with `uv run python`:

```bash
# Run pipeline scripts
uv run python scripts/00_setup_environment.py
uv run python scripts/01_run_tests.py
uv run python scripts/02_run_analysis.py
uv run python scripts/03_render_pdf.py

# Scripts automatically use uv if available, fall back to python3 if not
```

### Automatic Fallback

All Python scripts in the template automatically detect uv availability and fall back to `python3` if uv is not installed:

- **With uv**: Scripts use `uv run python` for consistent environments
- **Without uv**: Scripts use `python3` directly
- No configuration required - fallback is automatic

This ensures the template works in all environments.

### Lock File

The `uv.lock` file contains exact versions of all dependencies:

- **Purpose:** Ensures reproducible builds
- **Location:** `uv.lock` in project root
- **Management:** Auto-generated by uv
- **Version Control:** Should be committed to git

## Common Operations

### Installing Dependencies

**Install all dependencies:**
```bash
uv sync
```

**Install with development dependencies:**
```bash
uv sync --dev
```

**Install specific package:**
```bash
uv add package-name
```

### Adding Dependencies

**Add a new dependency:**
```bash
uv add numpy
```

**Add with version constraint:**
```bash
uv add "numpy>=1.22,<2.0"
```

**Add development dependency:**
```bash
uv add --dev pytest
```

**Add optional dependency group:**
```bash
uv add --optional dev mypy
```

### Updating Dependencies

**Update all dependencies:**
```bash
uv sync --upgrade
```

**Update specific package:**
```bash
uv add --upgrade package-name
```

**Update to latest compatible versions:**
```bash
uv sync --upgrade-package package-name
```

### Removing Dependencies

**Remove a package:**
```bash
uv remove package-name
```

**Remove from pyproject.toml only (keep in lock):**
```bash
uv remove --no-sync package-name
```

## Python Version Management

### Setting Python Version

**Specify Python version in pyproject.toml:**
```toml
[project]
requires-python = ">=3.10"
```

**Use specific Python version:**
```bash
uv python install 3.11
uv sync --python 3.11
```

**List available Python versions:**
```bash
uv python list
```

### Virtual Environment

**uv manages virtual environments automatically:**

- **Location:** `.venv/` in project root (default)
- **Activation:** Automatic with `uv run`
- **Manual activation:**
  ```bash
  source .venv/bin/activate  # Linux/macOS
  .venv\Scripts\activate     # Windows
  ```

## Lock File Management

### Understanding the Lock File

The `uv.lock` file contains:

- Exact versions of all dependencies
- Dependency resolution tree
- Platform-specific dependencies
- Hash verification for packages

### Updating the Lock File

**Regenerate lock file:**
```bash
uv lock
```

**Update lock file after dependency changes:**
```bash
uv sync  # Automatically updates lock file
```

**Lock file without installing:**
```bash
uv lock --no-install
```

### Lock File Best Practices

1. **Commit lock file** - Ensures reproducible builds
2. **Update regularly** - Keep dependencies current
3. **Review changes** - Check what updated
4. **Test after updates** - Verify everything works

## Integration with Build Pipeline

### Build Script Integration

The build pipeline uses uv automatically:

```bash
# In scripts/execute_pipeline.py
uv sync                    # Install dependencies
uv run pytest tests/      # Run tests
uv run python scripts/    # Run scripts
```

### Environment Variables

**Set Python path:**
```bash
export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
```

**Use uv in scripts:**
```bash
#!/bin/bash
uv sync
uv run python script.py
```

## Troubleshooting

### Common Issues

#### Issue: Lock file conflicts

**Symptoms:** Merge conflicts in `uv.lock`

**Solution:**
```bash
# Regenerate lock file
uv lock --upgrade

# Resolve conflicts
git checkout --theirs uv.lock
uv sync
```

#### Issue: Dependency resolution fails

**Symptoms:** `uv sync` fails with resolution errors

**Solution:**
```bash
# Check Python version compatibility
uv python list

# Update Python version requirement
# Edit pyproject.toml: requires-python = ">=3.10"

# Try upgrading
uv sync --upgrade
```

#### Issue: Package not found

**Symptoms:** `uv add package` fails

**Solution:**
- Check package name spelling
- Verify package exists on PyPI
- Try with explicit version: `uv add "package==1.0.0"`

#### Issue: Version conflicts

**Symptoms:** Dependency conflicts between packages

**Solution:**
```bash
# Check current versions
uv tree

# Update conflicting packages
uv sync --upgrade-package conflicting-package

# Or specify compatible versions manually
uv add "package1>=1.0,<2.0" "package2>=2.0,<3.0"
```

### Diagnostic Commands

**View dependency tree:**
```bash
uv tree
```

**Check installed packages:**
```bash
uv pip list
```

**Verify lock file:**
```bash
uv lock --check
```

**Show package information:**
```bash
uv pip show package-name
```

## Best Practices

### Dependency Management

1. **Use version constraints** - Specify compatible versions
2. **Update regularly** - Keep dependencies current
3. **Test updates** - Verify after updating
4. **Document decisions** - Note why specific versions are used

### Lock File Management

1. **Commit lock file** - Ensure reproducibility
2. **Update before release** - Fresh dependencies
3. **Review changes** - Understand what updated
4. **Test thoroughly** - Verify after updates

### Python Version

1. **Specify minimum version** - Use `requires-python`
2. **Test on multiple versions** - Ensure compatibility
3. **Document requirements** - Clear version needs
4. **Update gradually** - Don't jump versions abruptly

### Development Workflow

1. **Sync before development** - `uv sync` at start
2. **Add dependencies explicitly** - Use `uv add`
3. **Update lock file** - Commit after changes
4. **Test in clean environment** - Verify reproducibility

## Advanced Usage

### Custom Indexes

**Add custom package index:**
```toml
[[tool.uv.index]]
name = "custom"
url = "https://custom-index.example.com/simple"
```

### Dependency Groups

**Define dependency groups:**
```toml
[dependency-groups]
dev = [
    "mypy>=1.17.1",
    "pydocstyle>=6.3.0",
]
test = [
    "pytest>=8.4.1",
    "pytest-cov>=4.0",
]
```

**Install specific group:**
```bash
uv sync --group dev --group test
```

### Scripts and Commands

**Define scripts in pyproject.toml:**
```toml
[project.scripts]
my-script = "mypackage:main"
```

**Run scripts:**
```bash
uv run my-script
```

## Migration from Other Tools

### From pip

**Convert requirements.txt:**
```bash
# Install packages with uv
uv pip install -r requirements.txt

# Generate lock file
uv lock
```

### From Poetry

**Convert pyproject.toml:**
- Keep `[project]` section
- Remove `[tool.poetry]` section
- Run `uv sync` to generate lock file

### From conda

**Export environment:**
```bash
conda env export > environment.yml
```

**Install with uv:**
```bash
# Manually add packages from environment.yml
uv add package1 package2 ...
```

## Integration Examples

### Example 1: Adding New Dependency

```bash
# Add new package
uv add scipy

# Verify it was added to pyproject.toml
cat pyproject.toml

# Sync to install
uv sync

# Verify installation
uv pip list | grep scipy
```

### Example 2: Updating Dependencies

```bash
# Check current versions
uv tree

# Update all dependencies
uv sync --upgrade

# Review changes
git diff uv.lock

# Test after update
uv run pytest tests/
```

### Example 3: Clean Install

```bash
# Remove virtual environment
rm -rf .venv

# Remove lock file (optional)
rm uv.lock

# Reinstall everything
uv sync

# Verify
uv run python -c "import numpy; print(numpy.__version__)"
```

## Workspace Management

The template now supports uv workspaces for multi-project dependency management. This enables unified dependency management across multiple research projects.

### Workspace Configuration

The root `pyproject.toml` defines the workspace:

```toml
[tool.uv.workspace]
members = [
    "projects/code_project"
]
exclude = [
    "projects/*/output",
    "output"
]
```

### Workspace Commands

#### Sync Workspace Dependencies
```bash
# Sync all workspace dependencies
uv sync

# Or use the workspace management script
uv run python scripts/manage_workspace.py sync
```

#### Add Dependencies to Projects
```bash
# Add dependency to specific project
uv run python scripts/manage_workspace.py add numpy --project project

# Or manually change to project directory
cd projects/project
uv add scipy
```

#### Update Workspace Dependencies
```bash
# Update all workspace dependencies
uv run python scripts/manage_workspace.py update
```

#### Show Workspace Status
```bash
# Show workspace configuration and status
uv run python scripts/manage_workspace.py status

# Show dependency tree
uv run python scripts/manage_workspace.py tree
```

### Workspace Benefits

- **Unified Dependencies**: Shared dependencies managed centrally
- **Faster Resolution**: Single resolution pass for all projects
- **Consistent Environments**: All projects use same dependency versions
- **Simplified CI/CD**: Single sync command for entire workspace

### Workspace vs Project Dependencies

| Aspect | Workspace Root | Project-Specific |
|--------|---------------|------------------|
| **Scope** | All projects | Single project |
| **Use Case** | Shared tools (pytest, numpy) | Project-specific packages |
| **Management** | `uv sync` | `uv add` in project dir |
| **CI/CD** | Always synced | Synced per project |

## Summary

The `uv` package manager provides fast and reliable dependency management with workspace support for multi-project templates:

- **Fast resolution** - Quick dependency solving
- **Lock file** - Reproducible builds
- **Python management** - Version handling
- **Workspace support** - Multi-project dependency management
- **Integration** - Works with existing tools

For more information, see:
- [uv Documentation](https://docs.astral.sh/uv/)
- [Common Workflows](../reference/common-workflows.md)
- [Troubleshooting Guide](../operational/troubleshooting-guide.md)
- [Workspace Management Script](../../scripts/manage_workspace.py)

---

**Related Documentation:**
- [Quick Start Cheatsheet](../reference/quick-start-cheatsheet.md) - Essential commands
- [Build System](../operational/build-system.md) - Build pipeline details
- [Best Practices](../best-practices/best-practices.md) - Dependency management best practices


